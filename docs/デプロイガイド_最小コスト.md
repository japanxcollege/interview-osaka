# 最小コストデプロイガイド

## 💰 コスト試算（月額）

### プラン A: 完全無料（個人利用・開発用）
**総額: 0円/月**

| サービス | プラン | コスト | 制限 |
|---------|-------|--------|------|
| Vercel | Hobby | 無料 | 100GB帯域、ビルド時間制限あり |
| Render.com | Free | 無料 | 750時間/月、自動スリープあり |
| Gemini API | Free tier | 無料 | 60 RPM (Requests Per Minute) |
| Whisper API | Pay as you go | $0.006/min | 10時間=$3.6 |
| **合計** | | **$3.6～** | 使った分だけ |

### プラン B: 本番運用（小規模）
**総額: 約$15～30/月**

| サービス | プラン | コスト | 特徴 |
|---------|-------|--------|------|
| Vercel | Pro | $20/月 | 無制限ビルド、高速 |
| Render.com | Starter | $7/月 | 24時間稼働、スリープなし |
| Supabase | Free | 無料 | PostgreSQL 500MB |
| Gemini API | Free tier | 無料 | 60 RPM |
| Whisper API | Pay as you go | 従量課金 | 使った分だけ |
| **合計** | | **$27～** | 安定稼働 |

---

## 🚀 推奨デプロイ構成

### フロントエンド: Vercel（無料）
- **理由**: Next.jsの公式推奨、自動デプロイ
- **無料枠**: 個人利用なら十分
- **URL**: 自動でHTTPS付きURLが発行される

### バックエンド: Render.com（無料 or $7/月）
- **理由**: WebSocket対応、Pythonサポート
- **無料枠の注意**: 15分アクセスなしでスリープ（起動に30秒）
- **本番用**: $7/月で24時間稼働

### データベース: そのままJSON or Supabase
- **開発**: JSONファイル（Render.comの永続ディスク）
- **本番**: Supabase（無料枠あり）

---

## 📦 デプロイ手順

### ステップ1: バックエンド（Render.com）

#### 1.1 準備

```bash
cd /Users/shuta/jxc/interview-osaka/backend

# requirements.txtを確認
cat requirements.txt

# runtime.txtを作成（Pythonバージョン指定）
echo "python-3.11.14" > runtime.txt
```

#### 1.2 Render.com設定

1. [Render.com](https://render.com)にサインアップ
2. **New → Web Service**
3. リポジトリを接続（GitHub連携推奨）
4. 設定:
   ```
   Name: interview-editor-backend
   Environment: Python 3
   Region: Singapore (Asia最寄り)
   Branch: main
   Root Directory: backend
   Build Command: pip install -r requirements.txt
   Start Command: uvicorn main:app --host 0.0.0.0 --port $PORT
   ```

5. 環境変数を設定:
   ```
   GEMINI_API_KEY=your_key_here
   OPENAI_API_KEY=your_key_here
   BACKEND_PORT=$PORT
   ```

6. **Create Web Service**

#### 1.3 永続ディスク（データ保存用）

Render.comで:
1. サービス設定 → **Disks**
2. **Add Disk**
   ```
   Name: sessions-data
   Mount Path: /app/data
   Size: 1GB (無料)
   ```

---

### ステップ2: フロントエンド（Vercel）

#### 2.1 準備

```bash
cd /Users/shuta/jxc/interview-osaka/frontend

# .env.productionを作成
cat > .env.production << EOF
NEXT_PUBLIC_API_URL=https://interview-editor-backend.onrender.com
EOF
```

#### 2.2 Vercel設定

1. [Vercel](https://vercel.com)にサインアップ
2. **Import Project**
3. リポジトリを選択
4. 設定:
   ```
   Framework Preset: Next.js
   Root Directory: frontend
   Build Command: npm run build
   Output Directory: .next
   ```

5. 環境変数:
   ```
   NEXT_PUBLIC_API_URL=https://YOUR-BACKEND-URL.onrender.com
   ```

6. **Deploy**

---

### ステップ3: CORS設定を更新

バックエンドの`main.py`を更新:

```python
# CORS設定
allowed_origins = [
    "http://localhost:3000",
    "http://localhost:3001",
    "https://your-app.vercel.app",  # ← Vercelのドメインを追加
]
```

---

## 🔧 デプロイ用の設定ファイル

### backend/render.yaml（自動デプロイ設定）

```yaml
services:
  - type: web
    name: interview-editor-backend
    env: python
    region: singapore
    plan: free  # or starter ($7/月)
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.14
      - key: GEMINI_API_KEY
        sync: false  # 手動で設定
      - key: OPENAI_API_KEY
        sync: false
    disk:
      name: sessions-data
      mountPath: /app/data
      sizeGB: 1
```

---

## 💡 コスト最適化のヒント

### 1. Whisper APIのコスト削減

**現在**: 全音声をリアルタイムで文字起こし

**改善案**:
- **音声チャンクサイズを最適化**（現在より大きくして回数を減らす）
- **無音区間の検出**（無音は送信しない）

```python
# backend/components/AudioRecorder.tsx
const CHUNK_DURATION = 5000;  // 5秒（現在3秒→コスト33%削減）
```

**コスト例**:
- 1時間のインタビュー
- 現在: 3秒チャンクで1200回 × $0.006/分 = $7.2
- 改善後: 5秒チャンクで720回 × $0.006/分 = $4.3

### 2. Gemini APIの最適化

**無料枠**: 60 RPM（1分あたり60リクエスト）

**現状の使用頻度**:
- 質問提案: 5件ごと
- 原稿生成: 10件ごと
- 通常の録音では十分に余裕あり

**制限に引っかかる場合**:
- リトライロジックの実装
- キューイングシステムの導入

### 3. Render.comの無料枠活用

**無料プランの制限**:
- 15分アクセスなしで自動スリープ
- 起動に30秒かかる

**対策**:
- **外部からのping**: UptimeRobot（無料）で5分ごとにpingして起動状態を維持
- **ウォームアップリクエスト**: フロントエンドから定期的にヘルスチェック

```typescript
// frontend/lib/keepalive.ts
setInterval(() => {
  fetch(`${API_URL}/`).catch(() => {});
}, 5 * 60 * 1000); // 5分ごと
```

---

## 🎯 最小コストでのデプロイ（まとめ）

### 推奨構成: 無料プラン

```
┌─────────────────────────────────────┐
│ Vercel (無料)                        │
│ - Next.js フロントエンド             │
│ - 自動HTTPS                          │
│ - グローバルCDN                      │
└─────────────────────────────────────┘
           ↓ HTTPS
┌─────────────────────────────────────┐
│ Render.com (無料 or $7/月)          │
│ - FastAPI バックエンド               │
│ - WebSocket対応                      │
│ - 永続ディスク (1GB)                │
└─────────────────────────────────────┘
           ↓ API Calls
┌─────────────────────────────────────┐
│ Gemini API (無料60 RPM)             │
│ Whisper API (従量課金)              │
└─────────────────────────────────────┘
```

**月額コスト**: $0～$10
- Vercel: $0
- Render.com: $0（スリープあり）or $7（24時間稼働）
- Gemini: $0（無料枠内）
- Whisper: 使った分だけ（1時間=$0.36）

---

## 🔐 セキュリティ設定

### 環境変数の管理

```bash
# .env.example を作成（リポジトリにコミット）
GEMINI_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here
FRONTEND_URL=https://your-app.vercel.app

# 実際の.envはGitignore
echo ".env" >> .gitignore
```

### CORS設定

```python
# 本番用
allowed_origins = [
    "https://your-app.vercel.app",
]
```

---

## 📊 監視・ログ

### Render.com
- ビルトインログビューア
- メトリクス表示

### Vercel
- Analytics（無料）
- デプロイログ

### 外部監視（無料）
- **UptimeRobot**: 稼働監視
- **Better Uptime**: ダウンタイム通知

---

## 🚀 デプロイコマンド

### 初回デプロイ

```bash
# 1. GitHubにpush
git add .
git commit -m "Prepare for deployment"
git push origin main

# 2. Render.comとVercelが自動デプロイ
# （初回は手動で接続設定が必要）
```

### 更新デプロイ

```bash
git add .
git commit -m "Update feature"
git push origin main

# 自動的にデプロイされる
```

---

## ⚠️ 注意点

### Render.com 無料プランの制限
- **自動スリープ**: 15分未アクセスでスリープ
- **起動時間**: 30秒～1分
- **月間稼働時間**: 750時間（31日なら十分）

### 対策
1. **UptimeRobotでping** → スリープを防止
2. **$7/月のStarterプラン** → 24時間稼働

### データ永続化
- **無料プラン**: サービス再起動でデータ消失の可能性
- **ディスク追加**: 永続化（推奨）
- **本番環境**: Supabase等のDB推奨

---

## 📝 チェックリスト

- [ ] GitHubリポジトリ作成
- [ ] Render.comアカウント作成
- [ ] Vercelアカウント作成
- [ ] 環境変数を設定
- [ ] バックエンドデプロイ
- [ ] フロントエンドデプロイ
- [ ] CORS設定確認
- [ ] WebSocket動作確認
- [ ] Whisper API動作確認
- [ ] Gemini API動作確認
- [ ] UptimeRobot設定（オプション）

---

## 🎉 完成！

無料～$7/月で本格的なAIインタビューエディターがデプロイできます！










